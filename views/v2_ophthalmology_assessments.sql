CREATE OR REPLACE VIEW fhir_prd_db.v_ophthalmology_assessments AS
WITH visual_acuity_obs AS (SELECT o.id observation_fhir_id, SUBSTRING(o.subject_reference, 9) patient_fhir_id, TRY(DATE(TRY(from_iso8601_timestamp(o.effective_date_time)))) assessment_date, o.code_text assessment_name, 'visual_acuity' assessment_category, 'observation' source_table, o.value_quantity_value numeric_value, o.value_quantity_unit value_unit, o.value_string text_value, oc.component_code_text component_name, oc.component_value_quantity_value component_numeric_value, oc.component_value_quantity_unit component_unit, o.status observation_status, TRY(CAST(o.effective_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.observation o LEFT JOIN fhir_prd_db.observation_component oc ON (o.id = oc.observation_id)) WHERE ((LOWER(o.code_text) LIKE '%visual%acuity%') OR (LOWER(o.code_text) LIKE '%snellen%') OR (LOWER(o.code_text) LIKE '%logmar%') OR (LOWER(o.code_text) LIKE '%etdrs%') OR (LOWER(o.code_text) LIKE '%hotv%') OR (LOWER(o.code_text) LIKE '%lea%') OR (LOWER(o.code_text) LIKE '%vision%screening%') OR (LOWER(o.code_text) LIKE '%bcva%'))), fundus_optic_disc_obs AS (SELECT o.id observation_fhir_id, SUBSTRING(o.subject_reference, 9) patient_fhir_id, TRY(DATE(TRY(from_iso8601_timestamp(o.effective_date_time)))) assessment_date, o.code_text assessment_name, (CASE WHEN (LOWER(o.code_text) LIKE '%papilledema%') THEN 'optic_disc_papilledema' WHEN ((LOWER(o.code_text) LIKE '%optic%disc%') OR (LOWER(o.code_text) LIKE '%fundus%disc%')) THEN 'optic_disc_exam' WHEN (LOWER(o.code_text) LIKE '%fundus%macula%') THEN 'fundus_macula' WHEN (LOWER(o.code_text) LIKE '%fundus%vessel%') THEN 'fundus_vessels' WHEN (LOWER(o.code_text) LIKE '%fundus%vitreous%') THEN 'fundus_vitreous' WHEN (LOWER(o.code_text) LIKE '%fundus%periphery%') THEN 'fundus_periphery' ELSE 'fundus_other' END) assessment_category, 'observation' source_table, o.value_quantity_value numeric_value, o.value_quantity_unit value_unit, o.value_string text_value, oc.component_code_text component_name, oc.component_value_quantity_value component_numeric_value, oc.component_value_quantity_unit component_unit, o.status observation_status, TRY(CAST(o.effective_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.observation o LEFT JOIN fhir_prd_db.observation_component oc ON (o.id = oc.observation_id)) WHERE (((LOWER(o.code_text) LIKE '%fundus%') OR (LOWER(o.code_text) LIKE '%optic%disc%') OR (LOWER(o.code_text) LIKE '%papilledema%') OR (LOWER(o.code_text) LIKE '%optic%pallor%') OR (LOWER(o.code_text) LIKE '%optic%atrophy%') OR (LOWER(o.code_text) LIKE '%cup%disc%')) AND (NOT (LOWER(o.code_text) LIKE '%visual%acuity%')))), visual_field_procedures AS (SELECT p.id procedure_fhir_id, SUBSTRING(p.subject_reference, 9) patient_fhir_id, TRY(DATE(TRY(from_iso8601_timestamp(p.performed_date_time)))) assessment_date, p.code_text assessment_name, 'visual_field' assessment_category, 'procedure' source_table, null numeric_value, null value_unit, null text_value, null component_name, null component_numeric_value, null component_unit, p.status procedure_status, pc.code_coding_code cpt_code, pc.code_coding_display cpt_description, TRY(CAST(p.performed_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.procedure p LEFT JOIN fhir_prd_db.procedure_code_coding pc ON (p.id = pc.procedure_id)) WHERE ((LOWER(p.code_text) LIKE '%visual%field%') OR (LOWER(p.code_text) LIKE '%perimetry%') OR (LOWER(p.code_text) LIKE '%goldmann%') OR (LOWER(p.code_text) LIKE '%humphrey%') OR (pc.code_coding_code IN ('92081', '92082', '92083')))), oct_procedures AS (SELECT p.id procedure_fhir_id, SUBSTRING(p.subject_reference, 9) patient_fhir_id, TRY(DATE(TRY(from_iso8601_timestamp(p.performed_date_time)))) assessment_date, p.code_text assessment_name, (CASE WHEN (LOWER(p.code_text) LIKE '%optic%nerve%') THEN 'oct_optic_nerve' WHEN (LOWER(p.code_text) LIKE '%retina%') THEN 'oct_retina' WHEN (LOWER(p.code_text) LIKE '%macula%') THEN 'oct_macula' ELSE 'oct_unspecified' END) assessment_category, 'procedure' source_table, null numeric_value, null value_unit, null text_value, null component_name, null component_numeric_value, null component_unit, p.status procedure_status, pc.code_coding_code cpt_code, pc.code_coding_display cpt_description, TRY(CAST(p.performed_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.procedure p LEFT JOIN fhir_prd_db.procedure_code_coding pc ON (p.id = pc.procedure_id)) WHERE ((LOWER(p.code_text) LIKE '%oct%') OR (LOWER(p.code_text) LIKE '%optical%coherence%') OR (LOWER(p.code_text) LIKE '%rnfl%') OR (LOWER(p.code_text) LIKE '%ganglion%cell%') OR (pc.code_coding_code IN ('92133', '92134', '92133.999', '92134.999')))), fundus_photo_procedures AS (SELECT p.id procedure_fhir_id, SUBSTRING(p.subject_reference, 9) patient_fhir_id, TRY(DATE(TRY(from_iso8601_timestamp(p.performed_date_time)))) assessment_date, p.code_text assessment_name, 'fundus_photography' assessment_category, 'procedure' source_table, null numeric_value, null value_unit, null text_value, null component_name, null component_numeric_value, null component_unit, p.status procedure_status, pc.code_coding_code cpt_code, pc.code_coding_display cpt_description, TRY(CAST(p.performed_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.procedure p LEFT JOIN fhir_prd_db.procedure_code_coding pc ON (p.id = pc.procedure_id)) WHERE ((LOWER(p.code_text) LIKE '%fundus%photo%') OR (LOWER(p.code_text) LIKE '%fundus%imaging%') OR (LOWER(p.code_text) LIKE '%retinal%photo%') OR (pc.code_coding_code IN ('92250', '92225', '92226', '92227', '92228')))), ophthal_exam_procedures AS (SELECT p.id procedure_fhir_id, SUBSTRING(p.subject_reference, 9) patient_fhir_id, TRY(DATE(TRY(from_iso8601_timestamp(p.performed_date_time)))) assessment_date, p.code_text assessment_name, 'ophthalmology_exam' assessment_category, 'procedure' source_table, null numeric_value, null value_unit, null text_value, null component_name, null component_numeric_value, null component_unit, p.status procedure_status, pc.code_coding_code cpt_code, pc.code_coding_display cpt_description, TRY(CAST(p.performed_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.procedure p LEFT JOIN fhir_prd_db.procedure_code_coding pc ON (p.id = pc.procedure_id)) WHERE ((LOWER(p.code_text) LIKE '%ophthal%exam%') OR (LOWER(p.code_text) LIKE '%eye%exam%anes%') OR (LOWER(p.code_text) LIKE '%optic%nerve%decompression%') OR (LOWER(p.code_text) LIKE '%optic%glioma%') OR (pc.code_coding_code IN ('92002', '92004', '92012', '92014', '92018')))), ophthalmology_orders AS (SELECT sr.id service_request_fhir_id, SUBSTRING(sr.subject_reference, 9) patient_fhir_id, TRY(DATE(TRY(from_iso8601_timestamp(sr.authored_on)))) order_date, sr.code_text order_name, (CASE WHEN (LOWER(sr.code_text) LIKE '%visual%field%') THEN 'visual_field_order' WHEN (LOWER(sr.code_text) LIKE '%oct%optic%') THEN 'oct_optic_nerve_order' WHEN (LOWER(sr.code_text) LIKE '%oct%retina%') THEN 'oct_retina_order' WHEN (LOWER(sr.code_text) LIKE '%ophthal%') THEN 'ophthalmology_order' ELSE 'other_eye_order' END) order_category, 'service_request' source_table, sr.status order_status, sr.intent order_intent, TRY(CAST(sr.authored_on AS TIMESTAMP(3))) order_datetime FROM fhir_prd_db.service_request sr WHERE (((LOWER(sr.code_text) LIKE '%ophthal%') OR (LOWER(sr.code_text) LIKE '%visual%field%') OR (LOWER(sr.code_text) LIKE '%oct%') OR (LOWER(sr.code_text) LIKE '%optic%') OR (LOWER(sr.code_text) LIKE '%eye%exam%')) AND (NOT ((LOWER(sr.code_text) LIKE '%poct%') OR (LOWER(sr.code_text) LIKE '%glucose%'))))), ophthalmology_reports AS (SELECT dr.id diagnostic_report_fhir_id, SUBSTRING(dr.subject_reference, 9) patient_fhir_id, TRY(DATE(TRY(from_iso8601_timestamp(dr.effective_date_time)))) report_date, dr.code_text report_name, (CASE WHEN (LOWER(dr.code_text) LIKE '%visual%field%') THEN 'visual_field_report' WHEN (LOWER(dr.code_text) LIKE '%oct%optic%') THEN 'oct_optic_nerve_report' WHEN (LOWER(dr.code_text) LIKE '%oct%retina%') THEN 'oct_retina_report' WHEN (LOWER(dr.code_text) LIKE '%fundus%') THEN 'fundus_report' WHEN (LOWER(dr.code_text) LIKE '%vision%screening%') THEN 'vision_screening_report' ELSE 'other_eye_report' END) report_category, 'diagnostic_report' source_table, dr.status report_status, TRY(CAST(dr.effective_date_time AS TIMESTAMP(3))) report_datetime FROM fhir_prd_db.diagnostic_report dr WHERE (((LOWER(dr.code_text) LIKE '%ophthal%') OR (LOWER(dr.code_text) LIKE '%visual%field%') OR (LOWER(dr.code_text) LIKE '%oct%') OR (LOWER(dr.code_text) LIKE '%fundus%') OR (LOWER(dr.code_text) LIKE '%eye%') OR (LOWER(dr.code_text) LIKE '%vision%screening%')) AND (NOT ((LOWER(dr.code_text) LIKE '%poct%') OR (LOWER(dr.code_text) LIKE '%glucose%'))))), ophthalmology_documents AS (SELECT dref.id document_reference_fhir_id, SUBSTRING(dref.subject_reference, 9) patient_fhir_id, TRY(DATE(TRY(from_iso8601_timestamp(dref.date)))) document_date, dref.description document_description, dref.type_text document_type, (CASE WHEN (LOWER(dref.description) LIKE '%oct%') THEN 'oct_document' WHEN ((LOWER(dref.description) LIKE '%visual%field%') OR (LOWER(dref.description) LIKE '%goldman%')) THEN 'visual_field_document' WHEN (LOWER(dref.description) LIKE '%fundus%') THEN 'fundus_document' WHEN (LOWER(dref.description) LIKE '%ophthal%consult%') THEN 'ophthalmology_consult' WHEN (LOWER(dref.type_text) LIKE '%ophthal%') THEN 'ophthalmology_other' ELSE 'eye_related_document' END) document_category, 'document_reference' source_table, dref.status document_status, TRY(CAST(dref.date AS TIMESTAMP(3))) document_datetime, dc.content_attachment_url file_url, dc.content_attachment_content_type file_type FROM (fhir_prd_db.document_reference dref LEFT JOIN fhir_prd_db.document_reference_content dc ON (dref.id = dc.document_reference_id)) WHERE (((LOWER(dref.description) LIKE '%ophthal%') OR (LOWER(dref.description) LIKE '%visual%field%') OR (LOWER(dref.description) LIKE '%oct%') OR (LOWER(dref.description) LIKE '%fundus%') OR (LOWER(dref.description) LIKE '%eye%exam%') OR (LOWER(dref.type_text) LIKE '%ophthal%') OR (LOWER(dref.description) LIKE '%goldman%')) AND (NOT (LOWER(dref.description) LIKE '%octreotide%')))), all_assessments AS (SELECT observation_fhir_id record_fhir_id, patient_fhir_id, assessment_date, assessment_name assessment_description, assessment_category, source_table, observation_status record_status, null cpt_code, null cpt_description, numeric_value, value_unit, text_value, component_name, component_numeric_value, component_unit, null order_intent, null file_url, null file_type, full_datetime FROM visual_acuity_obs UNION ALL SELECT observation_fhir_id, patient_fhir_id, assessment_date, assessment_name, assessment_category, source_table, observation_status, null, null, numeric_value, value_unit, text_value, component_name, component_numeric_value, component_unit, null, null, null, full_datetime FROM fundus_optic_disc_obs UNION ALL SELECT procedure_fhir_id, patient_fhir_id, assessment_date, assessment_name, assessment_category, source_table, procedure_status, cpt_code, cpt_description, numeric_value, value_unit, text_value, component_name, component_numeric_value, component_unit, null, null, null, full_datetime FROM visual_field_procedures UNION ALL SELECT procedure_fhir_id, patient_fhir_id, assessment_date, assessment_name, assessment_category, source_table, procedure_status, cpt_code, cpt_description, numeric_value, value_unit, text_value, component_name, component_numeric_value, component_unit, null, null, null, full_datetime FROM oct_procedures UNION ALL SELECT procedure_fhir_id, patient_fhir_id, assessment_date, assessment_name, assessment_category, source_table, procedure_status, cpt_code, cpt_description, numeric_value, value_unit, text_value, component_name, component_numeric_value, component_unit, null, null, null, full_datetime FROM fundus_photo_procedures UNION ALL SELECT procedure_fhir_id, patient_fhir_id, assessment_date, assessment_name, assessment_category, source_table, procedure_status, cpt_code, cpt_description, numeric_value, value_unit, text_value, component_name, component_numeric_value, component_unit, null, null, null, full_datetime FROM ophthal_exam_procedures), all_orders AS (SELECT service_request_fhir_id record_fhir_id, patient_fhir_id, order_date assessment_date, order_name assessment_description, order_category assessment_category, source_table, order_status record_status, null cpt_code, null cpt_description, null numeric_value, null value_unit, null text_value, null component_name, null component_numeric_value, null component_unit, order_intent, null file_url, null file_type, order_datetime full_datetime FROM ophthalmology_orders), all_reports AS (SELECT diagnostic_report_fhir_id record_fhir_id, patient_fhir_id, report_date assessment_date, report_name assessment_description, report_category assessment_category, source_table, report_status record_status, null cpt_code, null cpt_description, null numeric_value, null value_unit, null text_value, null component_name, null component_numeric_value, null component_unit, null order_intent, null file_url, null file_type, report_datetime full_datetime FROM ophthalmology_reports), all_documents AS (SELECT document_reference_fhir_id record_fhir_id, patient_fhir_id, document_date assessment_date, document_description assessment_description, document_category assessment_category, source_table, document_status record_status, null cpt_code, null cpt_description, null numeric_value, null value_unit, null text_value, null component_name, null component_numeric_value, null component_unit, null order_intent, file_url, file_type, document_datetime full_datetime FROM ophthalmology_documents)
SELECT record_fhir_id, patient_fhir_id, assessment_date, assessment_description, assessment_category, source_table, record_status, cpt_code, cpt_description, numeric_value, value_unit, text_value, component_name, component_numeric_value, component_unit, order_intent, file_url, file_type, full_datetime FROM (SELECT * FROM all_assessments UNION ALL SELECT * FROM all_orders UNION ALL SELECT * FROM all_reports UNION ALL SELECT * FROM all_documents);