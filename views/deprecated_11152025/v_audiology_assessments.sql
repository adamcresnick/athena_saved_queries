CREATE OR REPLACE VIEW fhir_prd_db.v_audiology_assessments AS
WITH
  audiogram_thresholds AS (
   SELECT o.id observation_fhir_id, SUBSTRING(o.subject_reference, 9) patient_fhir_id, TRY(CAST(SUBSTR(o.effective_date_time, 1, 10) AS DATE)) assessment_date, (CASE WHEN (LOWER(o.code_text) LIKE '%left ear%') THEN 'left' WHEN (LOWER(o.code_text) LIKE '%right ear%') THEN 'right' END) ear_side, (CASE WHEN (LOWER(o.code_text) LIKE '%1000%hz%') THEN 1000 WHEN (LOWER(o.code_text) LIKE '%2000%hz%') THEN 2000 WHEN (LOWER(o.code_text) LIKE '%4000%hz%') THEN 4000 WHEN (LOWER(o.code_text) LIKE '%6000%hz%') THEN 6000 WHEN (LOWER(o.code_text) LIKE '%8000%hz%') THEN 8000 WHEN (LOWER(o.code_text) LIKE '%500%hz%') THEN 500 WHEN (LOWER(o.code_text) LIKE '%250%hz%') THEN 250 END) frequency_hz, o.value_quantity_value threshold_db, o.value_quantity_unit threshold_unit, o.code_text test_name, 'audiogram_threshold' assessment_category, 'observation' source_table, o.status observation_status, TRY(CAST(o.effective_date_time AS TIMESTAMP(3))) full_datetime FROM fhir_prd_db.observation o WHERE ((LOWER(o.code_text) LIKE '%ear%hz%') AND ((LOWER(o.code_text) LIKE '%1000%') OR (LOWER(o.code_text) LIKE '%2000%') OR (LOWER(o.code_text) LIKE '%4000%') OR (LOWER(o.code_text) LIKE '%6000%') OR (LOWER(o.code_text) LIKE '%8000%') OR (LOWER(o.code_text) LIKE '%500%') OR (LOWER(o.code_text) LIKE '%250%')))
), hearing_aid_status AS (
   SELECT o.id observation_fhir_id, SUBSTRING(o.subject_reference, 9) patient_fhir_id, TRY(CAST(SUBSTR(o.effective_date_time, 1, 10) AS DATE)) assessment_date, o.code_text assessment_name, (CASE WHEN (LOWER(o.code_text) LIKE '%hearing aid ear%') THEN 'hearing_aid_laterality' WHEN (LOWER(o.code_text) LIKE '%hearing aid%') THEN 'hearing_aid_required' END) assessment_category, 'observation' source_table, oc.component_value_string laterality_value, (CASE WHEN (LOWER(oc.component_value_string) LIKE '%both%ear%') THEN 'Bilateral' WHEN (LOWER(oc.component_value_string) LIKE '%right%ear%') THEN 'Right' WHEN (LOWER(oc.component_value_string) LIKE '%left%ear%') THEN 'Left' WHEN ((LOWER(o.code_text) LIKE '%hearing aid%') AND (oc.component_code_text IS NOT NULL)) THEN 'Yes' END) standardized_value, o.status observation_status, TRY(CAST(o.effective_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.observation o LEFT JOIN fhir_prd_db.observation_component oc ON (o.id = oc.observation_id)) WHERE (LOWER(o.code_text) LIKE '%hearing aid%')
), hearing_loss_observations AS (
   SELECT o.id observation_fhir_id, SUBSTRING(o.subject_reference, 9) patient_fhir_id, TRY(CAST(SUBSTR(o.effective_date_time, 1, 10) AS DATE)) assessment_date, o.code_text assessment_name, (CASE WHEN (LOWER(o.code_text) LIKE '%laterality%') THEN 'hearing_loss_laterality' WHEN (LOWER(o.code_text) LIKE '%hearing loss type%') THEN 'hearing_loss_type' WHEN (LOWER(o.code_text) LIKE '%sensorineural%') THEN 'hearing_loss_type' WHEN (LOWER(o.code_text) LIKE '%conductive%') THEN 'hearing_loss_type' WHEN (LOWER(o.code_text) LIKE '%hearing loss%') THEN 'hearing_loss_symptom' END) assessment_category, 'observation' source_table, (CASE WHEN (LOWER(o.code_text) LIKE '%sensorineural%') THEN 'Sensorineural' WHEN (LOWER(o.code_text) LIKE '%conductive%') THEN 'Conductive' WHEN (LOWER(o.code_text) LIKE '%mixed%') THEN 'Mixed' END) hearing_loss_type, (CASE WHEN (LOWER(oc.component_value_string) LIKE '%both%ear%') THEN 'Bilateral' WHEN (LOWER(oc.component_value_string) LIKE '%right%ear%') THEN 'Right' WHEN (LOWER(oc.component_value_string) LIKE '%left%ear%') THEN 'Left' END) laterality, oc.component_value_string raw_value, o.status observation_status, TRY(CAST(o.effective_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.observation o LEFT JOIN fhir_prd_db.observation_component oc ON (o.id = oc.observation_id)) WHERE (((LOWER(o.code_text) LIKE '%hearing loss%') OR (LOWER(o.code_text) LIKE '%sensorineural%') OR (LOWER(o.code_text) LIKE '%conductive%') OR (LOWER(o.code_text) LIKE '%hard of hearing%')) AND (NOT (LOWER(o.code_text) LIKE '%ear%hz%')))
), hearing_tests_other AS (
   SELECT o.id observation_fhir_id, SUBSTRING(o.subject_reference, 9) patient_fhir_id, TRY(CAST(SUBSTR(o.effective_date_time, 1, 10) AS DATE)) assessment_date, o.code_text assessment_name, (CASE WHEN (LOWER(o.code_text) LIKE '%hearing reception threshold%') THEN 'hearing_reception_threshold' WHEN (LOWER(o.code_text) LIKE '%hearing screen%result%') THEN 'hearing_screen_result' WHEN (LOWER(o.code_text) LIKE '%hearing%intact%') THEN 'hearing_exam_normal' WHEN (LOWER(o.code_text) LIKE '%vision and hearing%') THEN 'hearing_status_general' END) assessment_category, 'observation' source_table, o.value_quantity_value numeric_value, o.value_quantity_unit value_unit, oc.component_value_string text_value, o.status observation_status, TRY(CAST(o.effective_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.observation o LEFT JOIN fhir_prd_db.observation_component oc ON (o.id = oc.observation_id)) WHERE (((LOWER(o.code_text) LIKE '%hearing reception threshold%') OR (LOWER(o.code_text) LIKE '%hearing screen%') OR (LOWER(o.code_text) LIKE '%hearing%intact%') OR ((LOWER(o.code_text) LIKE '%vision and hearing%') AND (LOWER(o.code_text) LIKE '%hearing%'))) AND (NOT (LOWER(o.code_text) LIKE '%ear%hz%')))
), hearing_loss_diagnoses AS (
   SELECT c.id condition_fhir_id, SUBSTRING(c.subject_reference, 9) patient_fhir_id, TRY(CAST(SUBSTR(c.onset_date_time, 1, 10) AS DATE)) diagnosis_date, c.code_text diagnosis_name, (CASE WHEN (LOWER(c.code_text) LIKE '%ototoxic%') THEN 'ototoxic_hearing_loss' WHEN (LOWER(c.code_text) LIKE '%ototoxicity monitoring%') THEN 'ototoxicity_monitoring' WHEN (LOWER(c.code_text) LIKE '%sensorineural%') THEN 'sensorineural_hearing_loss' WHEN (LOWER(c.code_text) LIKE '%conductive%') THEN 'conductive_hearing_loss' WHEN (LOWER(c.code_text) LIKE '%mixed%') THEN 'mixed_hearing_loss' WHEN (LOWER(c.code_text) LIKE '%deaf%') THEN 'deafness' ELSE 'hearing_loss_unspecified' END) diagnosis_category, 'condition' source_table, (CASE WHEN (LOWER(c.code_text) LIKE '%sensorineural%') THEN 'Sensorineural' WHEN (LOWER(c.code_text) LIKE '%conductive%') THEN 'Conductive' WHEN (LOWER(c.code_text) LIKE '%mixed%') THEN 'Mixed' WHEN (LOWER(c.code_text) LIKE '%ototoxic%') THEN 'Ototoxic (Sensorineural)' END) hearing_loss_type, (CASE WHEN ((LOWER(c.code_text) LIKE '%bilateral%') OR (LOWER(c.code_text) LIKE '%both ears%')) THEN 'Bilateral' WHEN ((LOWER(c.code_text) LIKE '%unilateral%') AND (LOWER(c.code_text) LIKE '%left%')) THEN 'Left' WHEN ((LOWER(c.code_text) LIKE '%unilateral%') AND (LOWER(c.code_text) LIKE '%right%')) THEN 'Right' WHEN (LOWER(c.code_text) LIKE '%left ear%') THEN 'Left' WHEN (LOWER(c.code_text) LIKE '%right ear%') THEN 'Right' WHEN (LOWER(c.code_text) LIKE '%asymmetrical%') THEN 'Bilateral (asymmetric)' END) laterality, (CASE WHEN (LOWER(c.code_text) LIKE '%ototoxic%') THEN true ELSE false END) is_ototoxic, ccs.clinical_status_coding_code condition_status, TRY(CAST(c.onset_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.condition c LEFT JOIN fhir_prd_db.condition_clinical_status_coding ccs ON (c.id = ccs.condition_id)) WHERE ((LOWER(c.code_text) LIKE '%hearing loss%') OR (LOWER(c.code_text) LIKE '%deaf%') OR (LOWER(c.code_text) LIKE '%ototoxic%') OR (LOWER(c.code_text) LIKE '%ototoxicity%'))
), audiology_procedures AS (
   SELECT p.id procedure_fhir_id, SUBSTRING(p.subject_reference, 9) patient_fhir_id, TRY(CAST(SUBSTR(p.performed_date_time, 1, 10) AS DATE)) assessment_date, p.code_text procedure_name, (CASE WHEN (LOWER(p.code_text) LIKE '%audiometric screening%') THEN 'audiometric_screening' WHEN (LOWER(p.code_text) LIKE '%pure tone audiometry%') THEN 'pure_tone_audiometry' WHEN ((LOWER(p.code_text) LIKE '%speech%audiometry%') OR (LOWER(p.code_text) LIKE '%speech threshold%')) THEN 'speech_audiometry' WHEN (LOWER(p.code_text) LIKE '%air%bone%') THEN 'air_bone_audiometry' WHEN (LOWER(p.code_text) LIKE '%comprehensive hearing%') THEN 'comprehensive_hearing_test' WHEN (LOWER(p.code_text) LIKE '%hearing aid check%') THEN 'hearing_aid_check' WHEN ((LOWER(p.code_text) LIKE '%abr%') OR (LOWER(p.code_text) LIKE '%auditory brainstem%')) THEN 'abr_test' WHEN (LOWER(p.code_text) LIKE '%tympanometry%') THEN 'tympanometry' ELSE 'other_audiology_procedure' END) procedure_category, 'procedure' source_table, p.status procedure_status, pc.code_coding_code cpt_code, pc.code_coding_display cpt_description, TRY(CAST(p.performed_date_time AS TIMESTAMP(3))) full_datetime FROM (fhir_prd_db.procedure p LEFT JOIN fhir_prd_db.procedure_code_coding pc ON (p.id = pc.procedure_id)) WHERE ((LOWER(p.code_text) LIKE '%audiolog%') OR (LOWER(p.code_text) LIKE '%audiometr%') OR (LOWER(p.code_text) LIKE '%hearing%') OR (LOWER(p.code_text) LIKE '%abr%'))
), audiology_orders AS (
   SELECT sr.id service_request_fhir_id, SUBSTRING(sr.subject_reference, 9) patient_fhir_id, TRY(CAST(SUBSTR(sr.authored_on, 1, 10) AS DATE)) order_date, sr.code_text order_name, (CASE WHEN (LOWER(sr.code_text) LIKE '%audiolog%') THEN 'audiology_order' WHEN (LOWER(sr.code_text) LIKE '%audiometr%') THEN 'audiometry_order' WHEN (LOWER(sr.code_text) LIKE '%hearing%') THEN 'hearing_test_order' END) order_category, 'service_request' source_table, sr.status order_status, sr.intent order_intent, TRY(CAST(sr.authored_on AS TIMESTAMP(3))) order_datetime FROM fhir_prd_db.service_request sr WHERE ((LOWER(sr.code_text) LIKE '%audiolog%') OR (LOWER(sr.code_text) LIKE '%audiometr%') OR (LOWER(sr.code_text) LIKE '%hearing%'))
), audiology_reports AS (
   SELECT dr.id diagnostic_report_fhir_id, SUBSTRING(dr.subject_reference, 9) patient_fhir_id, TRY(CAST(SUBSTR(dr.effective_date_time, 1, 10) AS DATE)) report_date, dr.code_text report_name, (CASE WHEN (LOWER(dr.code_text) LIKE '%audiolog%') THEN 'audiology_report' WHEN (LOWER(dr.code_text) LIKE '%audiometr%') THEN 'audiometry_report' WHEN (LOWER(dr.code_text) LIKE '%hearing%') THEN 'hearing_test_report' END) report_category, 'diagnostic_report' source_table, dr.status report_status, TRY(CAST(dr.effective_date_time AS TIMESTAMP(3))) report_datetime FROM fhir_prd_db.diagnostic_report dr WHERE ((LOWER(dr.code_text) LIKE '%audiolog%') OR (LOWER(dr.code_text) LIKE '%audiometr%') OR (LOWER(dr.code_text) LIKE '%hearing%'))
), audiology_documents AS (
   SELECT dref.id document_reference_fhir_id, SUBSTRING(dref.subject_reference, 9) patient_fhir_id, TRY(CAST(SUBSTR(dref.date, 1, 10) AS DATE)) document_date, dref.description document_description, dref.type_text document_type, (CASE WHEN (LOWER(dref.type_text) LIKE '%audiologic assessment%') THEN 'audiologic_assessment_document' WHEN (LOWER(dref.description) LIKE '%audiolog%evaluation%') THEN 'audiology_evaluation_document' WHEN (LOWER(dref.description) LIKE '%audiometr%') THEN 'audiometry_document' WHEN (LOWER(dref.description) LIKE '%hearing%') THEN 'hearing_test_document' ELSE 'audiology_other_document' END) document_category, 'document_reference' source_table, dref.status document_status, TRY(CAST(dref.date AS TIMESTAMP(3))) document_datetime, dc.content_attachment_url file_url, dc.content_attachment_content_type file_type FROM (fhir_prd_db.document_reference dref LEFT JOIN fhir_prd_db.document_reference_content dc ON (dref.id = dc.document_reference_id)) WHERE ((LOWER(dref.description) LIKE '%audiolog%') OR (LOWER(dref.type_text) LIKE '%audiolog%') OR (LOWER(dref.description) LIKE '%hearing%') OR (LOWER(dref.type_text) LIKE '%hearing%'))
)
SELECT 'audiogram' data_type, observation_fhir_id record_fhir_id, patient_fhir_id, assessment_date, test_name assessment_description, assessment_category, source_table, observation_status record_status, ear_side, frequency_hz, threshold_db, threshold_unit, null hearing_loss_type, null laterality, null is_ototoxic, null cpt_code, null cpt_description, null order_intent, null file_url, null file_type, full_datetime FROM audiogram_thresholds
UNION ALL SELECT 'hearing_aid' data_type, observation_fhir_id record_fhir_id, patient_fhir_id, assessment_date, assessment_name assessment_description, assessment_category, source_table, observation_status record_status, null ear_side, null frequency_hz, null threshold_db, null threshold_unit, null hearing_loss_type, standardized_value laterality, null is_ototoxic, null cpt_code, null cpt_description, null order_intent, null file_url, null file_type, full_datetime FROM hearing_aid_status
UNION ALL SELECT 'hearing_loss_observation' data_type, observation_fhir_id record_fhir_id, patient_fhir_id, assessment_date, assessment_name assessment_description, assessment_category, source_table, observation_status record_status, null ear_side, null frequency_hz, null threshold_db, null threshold_unit, hearing_loss_type, laterality, null is_ototoxic, null cpt_code, null cpt_description, null order_intent, null file_url, null file_type, full_datetime FROM hearing_loss_observations
UNION ALL SELECT 'hearing_test' data_type, observation_fhir_id record_fhir_id, patient_fhir_id, assessment_date, assessment_name assessment_description, assessment_category, source_table, observation_status record_status, null ear_side, null frequency_hz, CAST(numeric_value AS VARCHAR) threshold_db, value_unit threshold_unit, null hearing_loss_type, null laterality, null is_ototoxic, null cpt_code, null cpt_description, null order_intent, null file_url, null file_type, full_datetime FROM hearing_tests_other
UNION ALL SELECT 'diagnosis' data_type, condition_fhir_id record_fhir_id, patient_fhir_id, diagnosis_date assessment_date, diagnosis_name assessment_description, diagnosis_category assessment_category, source_table, condition_status record_status, null ear_side, null frequency_hz, null threshold_db, null threshold_unit, hearing_loss_type, laterality, is_ototoxic, null cpt_code, null cpt_description, null order_intent, null file_url, null file_type, full_datetime FROM hearing_loss_diagnoses
UNION ALL SELECT 'procedure' data_type, procedure_fhir_id record_fhir_id, patient_fhir_id, assessment_date, procedure_name assessment_description, procedure_category assessment_category, source_table, procedure_status record_status, null ear_side, null frequency_hz, null threshold_db, null threshold_unit, null hearing_loss_type, null laterality, null is_ototoxic, cpt_code, cpt_description, null order_intent, null file_url, null file_type, full_datetime FROM audiology_procedures
UNION ALL SELECT 'order' data_type, service_request_fhir_id record_fhir_id, patient_fhir_id, order_date assessment_date, order_name assessment_description, order_category assessment_category, source_table, order_status record_status, null ear_side, null frequency_hz, null threshold_db, null threshold_unit, null hearing_loss_type, null laterality, null is_ototoxic, null cpt_code, null cpt_description, order_intent, null file_url, null file_type, order_datetime full_datetime FROM audiology_orders
UNION ALL SELECT 'report' data_type, diagnostic_report_fhir_id record_fhir_id, patient_fhir_id, report_date assessment_date, report_name assessment_description, report_category assessment_category, source_table, report_status record_status, null ear_side, null frequency_hz, null threshold_db, null threshold_unit, null hearing_loss_type, null laterality, null is_ototoxic, null cpt_code, null cpt_description, null order_intent, null file_url, null file_type, report_datetime full_datetime FROM audiology_reports
UNION ALL SELECT 'document' data_type, document_reference_fhir_id record_fhir_id, patient_fhir_id, document_date assessment_date, document_description assessment_description, document_category assessment_category, source_table, document_status record_status, null ear_side, null frequency_hz, null threshold_db, null threshold_unit, null hearing_loss_type, null laterality, null is_ototoxic, null cpt_code, null cpt_description, null order_intent, file_url, file_type, document_datetime full_datetime FROM audiology_documents;